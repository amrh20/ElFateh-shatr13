<!-- Hero -->
<section class="products-hero text-white text-center py-5">
  <div class="container position-relative">
    <div class="hero-shape hero-shape-start"></div>
    <div class="hero-shape hero-shape-end"></div>
    <h1 class="display-5 fw-bold mb-3">جميع المنتجات</h1>
    <p class="lead mx-auto mb-0 hero-text">اكتشف مجموعتنا الكاملة من المنتجات عالية الجودة</p>
  </div>
</section>

<!-- Mobile Controls -->
<div class="mobile-toolbar d-md-none">
  <button type="button" class="btn btn-primary shadow-sm w-100" (click)="openSideNav()">
    <i class="fas fa-search me-2"></i>
    بحث
  </button>
  <div class="text-center text-muted mt-2 small">
    <ng-container *ngIf="totalItems > 0; else noResults">
      تم العثور على {{ totalItems }} منتج
    </ng-container>
    <ng-template #noResults>
      <span *ngIf="!loading">لم يتم العثور على منتجات</span>
    </ng-template>
  </div>
</div>

<!-- Desktop Filters -->
<section class="products-toolbar d-none d-md-block">
  <div class="container">
    <div class="card shadow-sm border-0 toolbar-card">
      <div class="card-body">
        <form [formGroup]="filterForm" class="row g-3 align-items-center">
          <div class="col-12 col-lg-4">
            <label class="form-label fw-semibold mb-2">البحث</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
              <input type="text"
                     class="form-control"
                     placeholder="ابحث عن منتج..."
                     [value]="searchQuery"
                     (input)="onSearchChange($any($event.target).value)">
            </div>
          </div>

          <div class="col-6 col-lg-2">
            <label class="form-label fw-semibold mb-2">الصنف</label>
            <select class="form-select"
                    formControlName="subcategory">
              <option value="">جميع الأصناف</option>
              <option *ngFor="let subcategory of subCategories"
                      [value]="subcategory._id || subcategory.id">
                {{ subcategory.name }}
              </option>
            </select>
          </div>

          <div class="col-6 col-lg-2">
            <label class="form-label fw-semibold mb-2">السعر من</label>
            <input type="number"
                   class="form-control"
                   placeholder="0"
                   formControlName="minPrice">
          </div>

          <div class="col-6 col-lg-2">
            <label class="form-label fw-semibold mb-2">السعر إلى</label>
            <input type="number"
                   class="form-control"
                   placeholder="1000"
                   formControlName="maxPrice">
          </div>

          <div class="col-6 col-lg-2">
            <label class="form-label fw-semibold mb-2">نوع المنتج</label>
            <select class="form-select"
                    formControlName="productType">
              <option value="">جميع الأنواع</option>
              <option *ngFor="let type of productTypes" [value]="type.value">
                {{ type.label }}
              </option>
            </select>
          </div>

          <div class="col-12 col-lg-3 ms-lg-auto">
            <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-2 justify-content-between text-center text-lg-start">
              <div class="text-muted small">
                <ng-container *ngIf="totalItems > 0; else noDesktopResults">
                  <i class="fas fa-circle text-success me-1"></i>
                  <strong class="text-primary">{{ totalItems }}</strong> منتج
                </ng-container>
                <ng-template #noDesktopResults>
                  <span class="text-secondary">لا توجد منتجات</span>
                </ng-template>
              </div>
              <button type="button" class="btn btn-primary px-4" (click)="clearFilters()">
                مسح الفلاتر
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<!-- Products -->
<section class="products-content py-5">
  <div class="container">
    <!-- Loading -->
    <div *ngIf="loading" class="state-card text-center">
      <div class="spinner-border text-primary mb-3" role="status"></div>
      <p class="text-muted mb-0">جاري تحميل المنتجات...</p>
    </div>

    <!-- Error -->
    <div *ngIf="error && !loading" class="state-card text-center text-danger">
      <i class="fas fa-exclamation-triangle state-icon"></i>
      <h3 class="h4 fw-bold mb-2">حدث خطأ</h3>
      <p class="mb-3">{{ error }}</p>
      <button class="btn btn-primary" type="button" (click)="loadProducts()">
        إعادة المحاولة
      </button>
    </div>

    <!-- Products Grid -->
    <ng-container *ngIf="!loading && !error">
      <div class="row g-3 g-md-4 mb-4">
        <div class="col-6 col-md-4 col-lg-3"
             *ngFor="let product of paginatedProducts">
          <app-product-card
            [product]="product"
            (addToCartEvent)="onAddToCart($event)">
          </app-product-card>
        </div>
      </div>

      <!-- No Products Found -->
      <div *ngIf="paginatedProducts.length === 0" class="state-card text-center">
        <i class="fas fa-box-open state-icon"></i>
        <h3 class="h4 fw-bold mb-2">لم يتم العثور على منتجات</h3>
        <p class="text-muted mb-4">جرب تغيير الفلاتر أو البحث عن شيء آخر</p>
        <button class="btn btn-primary" type="button" (click)="clearFilters()">
          مسح البحث
        </button>
      </div>

      <!-- Pagination -->
      <nav *ngIf="totalPages > 0" class="pagination-wrapper mt-4" aria-label="التنقل بين الصفحات">
        <ul class="pagination justify-content-center flex-wrap gap-2">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <button class="page-link"
                    type="button"
                    (click)="onPageChange(currentPage - 1)"
                    [disabled]="currentPage === 1">
              <i class="fas fa-chevron-right"></i>
            </button>
          </li>

          <li class="page-item"
              *ngFor="let page of pageNumbers"
              [class.active]="page === currentPage"
              [class.disabled]="page === -1">
            <button class="page-link"
                    type="button"
                    [disabled]="page === -1"
                    (click)="page === -1 ? null : onPageChange(page)">
              {{ page === -1 ? '...' : page }}
            </button>
          </li>

          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <button class="page-link"
                    type="button"
                    (click)="onPageChange(currentPage + 1)"
                    [disabled]="currentPage === totalPages">
              <i class="fas fa-chevron-left"></i>
            </button>
          </li>
        </ul>
      </nav>

      <div *ngIf="totalPages > 1" class="text-center text-muted small">
        الصفحة {{ currentPage }} من {{ totalPages }} ({{ paginatedProducts.length }} من {{ totalItems }})
      </div>
    </ng-container>
  </div>
</section>

<!-- Mobile Side Navigation -->
<div class="mobile-side-nav" *ngIf="isSideNavOpen" (click)="onSideNavBackdropClick()">
  <div class="backdrop"></div>
  <div class="side-panel" (click)="$event.stopPropagation()">
    <div class="panel-header">
      <h2>البحث والفلترة</h2>
      <button type="button" class="btn-close-custom" (click)="closeSideNav()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="panel-body">
      <div class="mb-3">
        <label class="form-label fw-semibold">البحث</label>
        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-search"></i></span>
          <input type="text"
                 class="form-control"
                 placeholder="ابحث عن منتج..."
                 [value]="searchQuery"
                 (input)="onSearchChange($any($event.target).value)">
        </div>
      </div>

      <form [formGroup]="filterForm" class="vstack gap-3">
        <div>
          <label class="form-label fw-semibold">الصنف</label>
          <select class="form-select" formControlName="subcategory">
            <option value="">اختر الصنف</option>
            <option *ngFor="let subcategory of subCategories" [value]="subcategory._id || subcategory.id">
              {{ subcategory.name }}
            </option>
          </select>
        </div>

        <div>
          <label class="form-label fw-semibold">السعر من</label>
          <input type="number" class="form-control" formControlName="minPrice" placeholder="0">
        </div>

        <div>
          <label class="form-label fw-semibold">السعر إلى</label>
          <input type="number" class="form-control" formControlName="maxPrice" placeholder="1000">
        </div>

        <div>
          <label class="form-label fw-semibold">نوع المنتج</label>
          <select class="form-select" formControlName="productType">
            <option value="">جميع الأنواع</option>
            <option *ngFor="let type of productTypes" [value]="type.value">
              {{ type.label }}
            </option>
          </select>
        </div>
      </form>

      <div class="results-summary text-center text-muted small mt-3">
        <span *ngIf="totalItems > 0; else noMobileResults">تم العثور على {{ totalItems }} منتج</span>
        <ng-template #noMobileResults>
          <span>لم يتم العثور على منتجات</span>
        </ng-template>
      </div>

      <div class="d-grid gap-2 mt-4">
        <button class="btn btn-outline-primary" type="button" (click)="clearFilters(); closeSideNav()">
          مسح البحث
        </button>
        <button class="btn btn-primary" type="button" (click)="applyFiltersAndClose()">
          تطبيق الفلاتر
        </button>
      </div>
    </div>
  </div>
</div>
