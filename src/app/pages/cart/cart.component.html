<div class="cart-page py-5">
  <div class="container-xxl">

    <!-- Step Progress -->
    <div *ngIf="cartItems.length > 0" class="card border-0 shadow-sm rounded-4 mb-4 cart-stepper">
      <div class="card-body py-4 px-4 px-md-5">
        <div class="row g-3 align-items-center">
          <div class="col-12 col-lg-8 mx-auto">
            <div class="stepper-wrapper">
              <div class="stepper-item" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
                <div class="step-counter">1</div>
                <div class="step-name">ูุฑุงุฌุนุฉ ุงูุณูุฉ</div>
              </div>
              <div class="stepper-divider" [class.completed]="currentStep > 1"></div>
              <div class="stepper-item" [class.active]="currentStep >= 2">
                <div class="step-counter">2</div>
                <div class="step-name">ุจูุงูุงุช ุงูุชูุตูู</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 1: Cart Review -->
    <ng-container *ngIf="cartItems.length > 0 && currentStep === 1">
      <div class="row g-4">
        <!-- Cart Items -->
        <div class="col-12 col-lg-8">
          <div class="card border-0 shadow-sm rounded-4">
            <div class="card-header bg-white border-0 pt-4 px-4 px-md-5">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <h2 class="cart-section-title mb-1">ุงูููุชุฌุงุช</h2>
                  <p class="text-muted small mb-0">({{ totalItems }}) ููุชุฌ ูู ุงูุณูุฉ</p>
                </div>
                <button class="btn btn-link text-danger fw-semibold px-0" (click)="clearCart()">
                  ูุณุญ ุงูุณูุฉ
                </button>
              </div>
            </div>
            <div class="card-body p-0">
              <div *ngFor="let item of cartItems" class="cart-item border-top border-light" [class.border-0]="item === cartItems[0]">
                <div class="row g-3 align-items-center">
                  <div class="col-12 col-md-3">
                    <div class="item-thumb rounded-4 shadow-sm">
                      <img [src]="item.product.images?.[0] || 'assets/images/placeholder.png'" [alt]="item.product.name">
                      <span *ngIf="item.product.stock && item.product.stock <= 5" class="stock-badge">ุขุฎุฑ {{ item.product.stock }}</span>
                    </div>
                  </div>
                  <div class="col-12 col-md-9">
                    <div class="d-flex flex-column flex-md-row justify-content-between gap-3">
                      <div class="item-info">
                        <h3 class="item-title">{{ item.product.name }}</h3>
                        <p class="item-description">{{ item.product.description }}</p>
                        <div class="item-pricing">
                          <span class="current">{{ getItemPrice(item) }} ุฌ.ู</span>
                          <span *ngIf="item.product.originalPrice && item.product.originalPrice > getCurrentPrice(item.product)" class="original">
                            {{ item.product.originalPrice * item.quantity }} ุฌ.ู
                          </span>
                          <span *ngIf="item.product.originalPrice && item.product.originalPrice > getCurrentPrice(item.product)" class="saving">
                            ููุฑูุช {{ ((item.product.originalPrice - getCurrentPrice(item.product)) * item.quantity).toFixed(0) }} ุฌ.ู
                          </span>
                        </div>
                      </div>
                      <div class="item-controls">
                        <div class="quantity-control">
                          <button class="qty-btn" (click)="updateQuantity(item.product._id || item.product.id, item.quantity - 1)" [disabled]="item.quantity <= 1">
                            <i class="pi pi-minus"></i>
                          </button>
                          <span class="qty-value">{{ item.quantity }}</span>
                          <button class="qty-btn" (click)="updateQuantity(item.product._id || item.product.id, item.quantity + 1)">
                            <i class="pi pi-plus"></i>
                          </button>
                        </div>
                        <button class="btn btn-outline-danger btn-sm rounded-pill mt-3 px-3" (click)="removeFromCart(item.product._id || item.product.id)">
                          ุฅุฒุงูุฉ ุงูููุชุฌ
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-footer bg-white border-0 px-4 px-md-5 pb-4">
              <button class="btn btn-outline-secondary rounded-pill" routerLink="/categories">
                <i class="pi pi-arrow-right"></i>
                <span class="ms-2">ูุชุงุจุนุฉ ุงูุชุณูู</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="col-12 col-lg-4">
          <div class="card border-0 shadow-sm rounded-4 sticky-summary">
            <div class="card-body p-4 p-md-5">
              <h3 class="summary-title">ููุฎุต ุงูุทูุจ</h3>
              <ul class="summary-list list-unstyled mb-4">
                <li>
                  <span>ุงููุฌููุน ุงููุฑุนู</span>
                  <span>{{ subtotal }} ุฌ.ู</span>
                </li>
                <li>
                  <span>ุฑุณูู ุงูุชูุตูู</span>
                  <span>{{ deliveryFee }} ุฌ.ู</span>
                </li>
                <li *ngIf="discount > 0" class="saving">
                  <span>ุฎุตู ุงูููุชุฌุงุช</span>
                  <span>-{{ discount }} ุฌ.ู</span>
                </li>
                <li *ngIf="couponDiscount > 0" class="saving">
                  <span>ุฎุตู ุงูููุจูู</span>
                  <span>-{{ couponDiscount }} ุฌ.ู</span>
                </li>
              </ul>

              <!-- Coupon -->
              <div class="coupon-box mb-4">
                <h4 class="coupon-title">ููุจูู ุงูุฎุตู</h4>
                <div class="coupon-form">
                  <div class="coupon-input">
                    <input type="text"
                           class="form-control"
                           placeholder="ุฃุฏุฎู ููุฏ ุงูููุจูู"
                           [(ngModel)]="couponCode"
                           [disabled]="isCouponLoading"
                           [class.is-valid]="isCouponValid"
                           [class.is-invalid]="!isCouponValid && couponMessage">
                    <button class="btn-apply" type="button" (click)="applyCoupon()" [disabled]="isCouponLoading || !couponCode.trim()">
                      <span *ngIf="!isCouponLoading">ุชุทุจูู</span>
                      <span *ngIf="isCouponLoading" class="spinner-border spinner-border-sm"></span>
                    </button>
                  </div>
                  <div *ngIf="couponMessage" class="coupon-message" [class.valid]="isCouponValid" [class.invalid]="!isCouponValid">
                    {{ couponMessage }}
                  </div>
                  <div *ngIf="appliedCoupon" class="applied-coupon">
                    <span class="badge bg-success-subtle text-success">{{ appliedCoupon }}</span>
                    <button type="button" class="btn btn-link text-danger p-0 ms-2" (click)="removeCoupon()">ุฅุฒุงูุฉ</button>
                  </div>
                </div>
              </div>

              <div class="summary-total d-flex justify-content-between align-items-center mb-4">
                <span>ุงููุฌููุน ุงูููู</span>
                <span class="total-value">{{ total }} ุฌ.ู</span>
              </div>

              <button class="btn btn-danger w-100 rounded-pill py-3" (click)="nextStep()" [disabled]="!canProceedToPayment()">
                ูุชุงุจุนุฉ ุฅูู ุงูุฏูุน
              </button>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Step 2: Checkout Form -->
    <ng-container *ngIf="cartItems.length > 0 && currentStep === 2">
      <div class="row g-4">
        <div class="col-12 col-lg-8">
          <div class="card border-0 shadow-sm rounded-4">
            <div class="card-header bg-white border-0 pt-4 px-4 px-md-5">
              <h2 class="cart-section-title mb-0">ูุนูููุงุช ุงูุชูุตูู ูุงูุฏูุน</h2>
            </div>
            <div class="card-body px-4 px-md-5 pb-5">
              <form [formGroup]="checkoutForm" (ngSubmit)="submitOrder()" novalidate class="checkout-form">
                <div class="row g-4">
                  <div class="col-md-6">
                    <label class="form-label">ุงูุงุณู ุงููุงูู <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" formControlName="fullName" [class.is-invalid]="isFieldInvalid('fullName')" placeholder="ุฃุฏุฎู ุงุณูู ุงููุงูู">
                    <div class="invalid-feedback">ุงูุงุณู ุงููุงูู ูุทููุจ</div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">ุฑูู ุงูููุจุงูู <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" formControlName="mobileNumber" [class.is-invalid]="isFieldInvalid('mobileNumber')" placeholder="ุฃุฏุฎู ุฑูู ุงูููุจุงูู">
                    <div class="invalid-feedback">ุฑูู ุงูููุจุงูู ูุทููุจ</div>
                  </div>

                  <!-- Address Mode -->
                  <div class="col-12">
                    <label class="form-label">ุงุฎุชูุงุฑ ุงูุนููุงู</label>
                    <div class="address-mode">
                      <label class="address-option" [class.active]="!useExistingAddress">
                        <input type="radio" [checked]="!useExistingAddress" (change)="toggleAddressMode()">
                        <div class="option-body">
                          <h5>ุนููุงู ุฌุฏูุฏ</h5>
                          <p>ุฃุฏุฎู ุนููุงู ุชูุตูู ุฌุฏูุฏ</p>
                        </div>
                      </label>
                      <label class="address-option" *ngIf="savedAddresses.length > 0" [class.active]="useExistingAddress">
                        <input type="radio" [checked]="useExistingAddress" (change)="toggleAddressMode()">
                        <div class="option-body">
                          <h5>ุนููุงู ูุญููุธ</h5>
                          <p>ุงุฎุชุฑ ูู ูุงุฆูุฉ ุงูุนูุงููู ุงูุณุงุจูุฉ</p>
                        </div>
                      </label>
                    </div>
                  </div>

                  <div class="col-12" *ngIf="useExistingAddress">
                    <div *ngIf="isLoadingAddresses" class="text-center py-4">
                      <div class="spinner-border text-danger"></div>
                      <p class="text-muted mt-3 mb-0">ุฌุงุฑู ุชุญููู ุงูุนูุงููู...</p>
                    </div>
                    <ng-container *ngIf="!isLoadingAddresses">
                      <select class="form-select" [formControl]="addressSelectionControl" (change)="onAddressSelect()">
                        <option value="">-- ุงุฎุชุฑ ุงูุนููุงู --</option>
                        <option *ngFor="let addr of savedAddresses" [value]="addr._id">
                          {{ addr.address.city }} - {{ addr.address.street }} ({{ addr.phone }})
                        </option>
                      </select>
                    </ng-container>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">ุงูููุทูุฉ <span class="text-danger">*</span></label>
                    <select class="form-select" formControlName="city" [class.is-invalid]="isFieldInvalid('city')">
                      <option value="" disabled>ุงุฎุชุฑ ุงูููุทูุฉ</option>
                      <option *ngFor="let area of zahraaMaadiAreas" [value]="area">{{ area }}</option>
                    </select>
                    <div class="invalid-feedback">ุงูููุทูุฉ ูุทููุจุฉ</div>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">ุทุฑููุฉ ุงูุฏูุน</label>
                    <div class="payment-option">
                      <label class="payment-card">
                        <input type="radio" formControlName="paymentMethod" value="cash_on_delivery" checked>
                        <div class="payment-body">
                          <h6>ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู</h6>
                          <p class="mb-0">ุงุฏูุน ููุฏุงู ุนูุฏ ุงุณุชูุงู ุงูุทูุจ</p>
                        </div>
                      </label>
                    </div>
                  </div>

                  <div class="col-12">
                    <label class="form-label">ุนููุงู ุงูุชูุตูู <span class="text-danger">*</span></label>
                    <textarea class="form-control" rows="3" formControlName="deliveryAddress" [class.is-invalid]="isFieldInvalid('deliveryAddress')" placeholder="ุฃุฏุฎู ุงูุนููุงู ุจุงูุชูุตูู"></textarea>
                    <div class="invalid-feedback">ุนููุงู ุงูุชูุตูู ูุทููุจ</div>
                  </div>

                  <div class="col-12">
                    <label class="form-label">ููุงุญุธุงุช ุฅุถุงููุฉ</label>
                    <textarea class="form-control" rows="3" formControlName="additionalNotes" placeholder="ุฃู ููุงุญุธุงุช ููุชูุตูู (ุงุฎุชูุงุฑู)"></textarea>
                  </div>
                </div>

                <div class="form-actions d-flex flex-column flex-md-row justify-content-between gap-3 mt-5">
                  <button type="button" class="btn btn-light rounded-pill px-4" (click)="previousStep()">
                    <i class="pi pi-arrow-left"></i>
                    <span class="ms-2">ุงูุนูุฏุฉ ููุณูุฉ</span>
                  </button>
                  <button type="submit" class="btn btn-danger rounded-pill px-5" [disabled]="!checkoutForm.valid || isSubmitting">
                    <span *ngIf="!isSubmitting">ุฅุชูุงู ุงูุทูุจ</span>
                    <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm"></span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Summary Sidebar -->
        <div class="col-12 col-lg-4">
          <div class="card border-0 shadow-sm rounded-4 sticky-summary">
            <div class="card-body p-4 p-md-5">
              <h3 class="summary-title">ููุฎุต ุงูุทูุจ</h3>
              <ul class="summary-list list-unstyled mb-4">
                <li>
                  <span>ุงููุฌููุน ุงููุฑุนู</span>
                  <span>{{ subtotal }} ุฌ.ู</span>
                </li>
                <li *ngIf="discount > 0" class="saving">
                  <span>ุฎุตู ุงูููุชุฌุงุช</span>
                  <span>-{{ discount }} ุฌ.ู</span>
                </li>
                <li *ngIf="couponDiscount > 0" class="saving">
                  <span>ุฎุตู ุงูููุจูู</span>
                  <span>-{{ couponDiscount }} ุฌ.ู</span>
                </li>
                <li>
                  <span>ุฑุณูู ุงูุชูุตูู</span>
                  <span>{{ deliveryFee }} ุฌ.ู</span>
                </li>
              </ul>
              <div class="summary-total d-flex justify-content-between align-items-center mb-4">
                <span>ุงููุฌููุน ุงูููู</span>
                <span class="total-value">{{ total }} ุฌ.ู</span>
              </div>
              <div class="order-items">
                <h4>ุงูููุชุฌุงุช ุงููุทููุจุฉ</h4>
                <div class="order-item" *ngFor="let item of cartItems">
                  <div class="d-flex align-items-center gap-3">
                    <img [src]="item.product.images?.[0] || 'assets/images/placeholder.png'" [alt]="item.product.name">
                    <div>
                      <p class="mb-0 small fw-semibold">{{ item.product.name }}</p>
                      <span class="badge rounded-pill bg-light text-muted">ุงููููุฉ: {{ item.quantity }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Empty Cart -->
    <div *ngIf="cartItems.length === 0" class="empty-cart text-center py-5">
      <div class="card border-0 shadow-lg rounded-4 mx-auto" style="max-width: 460px;">
        <div class="card-body p-5">
          <div class="icon-wrapper mb-4">
            <i class="pi pi-shopping-cart"></i>
          </div>
          <h3 class="mb-3">ุณูุฉ ุงูุชุณูู ูุงุฑุบุฉ</h3>
          <p class="text-muted mb-4">ูู ุจุฅุถุงูุฉ ููุชุฌุงุชู ุงูููุถูุฉ ูุชุฑุงูุง ููุง</p>
          <a routerLink="/categories" class="btn btn-danger rounded-pill px-4">ุชุตูุญ ุงูููุชุฌุงุช</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Dialog -->
  <div *ngIf="showSuccessDialog" class="cart-dialog-overlay" role="dialog">
    <div class="cart-dialog success">
      <div class="dialog-header">
        <div class="success-icon">
          <i class="pi pi-check"></i>
        </div>
        <h3>ุชู ุฅูุดุงุก ุงูุทูุจ ุจูุฌุงุญ! ๐</h3>
      </div>
      <div class="dialog-body">
        <p class="text-muted">ุดูุฑุงู ูู! ุณูุชู ุงูุชูุงุตู ูุนู ูุฑูุจุงู ูุชุฃููุฏ ุงูุชูุงุตูู.</p>
        <div class="dialog-summary">
          <div><span>ุนุฏุฏ ุงูููุชุฌุงุช:</span><span>{{ savedOrderDetails.totalItems }}</span></div>
          <div><span>ุงููุฌููุน ุงููุฑุนู:</span><span>{{ savedOrderDetails.subtotal }} ุฌ.ู</span></div>
          <div *ngIf="savedOrderDetails.discount > 0"><span>ุฎุตู ุงูููุชุฌุงุช:</span><span>-{{ savedOrderDetails.discount }} ุฌ.ู</span></div>
          <div *ngIf="savedOrderDetails.couponDiscount > 0"><span>ุฎุตู ุงูููุจูู:</span><span>-{{ savedOrderDetails.couponDiscount }} ุฌ.ู</span></div>
          <div><span>ุฑุณูู ุงูุชูุตูู:</span><span>{{ savedOrderDetails.deliveryFee }} ุฌ.ู</span></div>
          <div class="total"><span>ุงููุฌููุน ุงูููู:</span><span>{{ savedOrderDetails.total }} ุฌ.ู</span></div>
        </div>
      </div>
      <div class="dialog-actions">
        <button *ngIf="isUserAuthenticated" class="btn btn-outline-danger rounded-pill" (click)="goToTrackOrder()">ุชุชุจุน ุงูุทูุจ</button>
        <button class="btn btn-danger rounded-pill" (click)="closeSuccessDialog()">ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</button>
      </div>
      <p class="dialog-note" *ngIf="!isUserAuthenticated">ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูุชุชุจุน ุงูุทูุจ ูุงุญูุงู</p>
    </div>
  </div>

  <!-- Invalid Discount Dialog -->
  <div *ngIf="showInvalidDiscountDialog" class="cart-dialog-overlay" role="dialog">
    <div class="cart-dialog warning">
      <div class="dialog-header">
        <div class="warning-icon">
          <i class="pi pi-exclamation-triangle"></i>
        </div>
        <h3>ูุดููุฉ ูู ููุฏ ุงูุฎุตู</h3>
      </div>
      <div class="dialog-body">
        <p class="text-muted">{{ invalidDiscountMessage }}</p>
        <div class="dialog-summary">
          <div class="total"><span>ุฅุฌูุงูู ุงูุทูุจ ุจุฏูู ุงูุฎุตู:</span><span>{{ orderWithoutDiscount }} ุฌ.ู</span></div>
        </div>
      </div>
      <div class="dialog-actions">
        <button class="btn btn-success rounded-pill" (click)="proceedWithoutDiscount()">ูุชุงุจุนุฉ ุจุฏูู ุฎุตู</button>
        <button class="btn btn-outline-secondary rounded-pill" (click)="goBackToCart()">ุงูุนูุฏุฉ ููุณูุฉ</button>
        <button class="btn btn-light rounded-pill" (click)="closeInvalidDiscountDialog()">ุฅูุบุงุก</button>
      </div>
    </div>
  </div>

  <!-- Authentication Popup -->
  <div *ngIf="showAuthPopup" class="cart-auth-overlay" role="dialog">
    <div class="cart-auth-modal">
      <button type="button" class="btn-close" (click)="closeAuthPopup()"></button>
      <div class="auth-header text-center">
        <h3>{{ isLoginMode ? 'ุชุณุฌูู ุงูุฏุฎูู' : 'ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ' }}</h3>
        <p class="text-muted">{{ isLoginMode ? 'ุณุฌู ุฏุฎููู ูุงุณุชุฎุฏุงู ุงูููุจูู ููุชุงุจุนุฉ ุงูุทูุจ' : 'ุฃูุดุฆ ุญุณุงุจ ุฌุฏูุฏ ูุงุณุชูุฏ ูู ุงูููุจูู' }}</p>
      </div>
      <form [formGroup]="authForm" (ngSubmit)="submitAuth()" class="auth-form">
        <div *ngIf="!isLoginMode" class="mb-3">
          <label class="form-label">ุงูุงุณู ุงููุงูู</label>
          <input class="form-control" type="text" formControlName="fullName" placeholder="ุฃุฏุฎู ุงุณูู ุงููุงูู">
        </div>
        <div class="mb-3">
          <label class="form-label">ุฑูู ุงููุงุชู / ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
          <input class="form-control" type="text" formControlName="email" placeholder="ุฑูู ุงููุงุชู ุฃู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู">
        </div>
        <div class="mb-3">
          <label class="form-label">ูููุฉ ุงููุฑูุฑ</label>
          <div class="password-field">
            <input class="form-control" [type]="showPassword ? 'text' : 'password'" formControlName="password" placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ">
            <button type="button" class="toggle-password" (click)="togglePasswordVisibility()">
              <i class="pi" [class.pi-eye]="!showPassword" [class.pi-eye-slash]="showPassword"></i>
            </button>
          </div>
        </div>
        <div *ngIf="authMessage" class="alert" [class.alert-success]="authMessage.includes('ูุฌุงุญ')" [class.alert-danger]="!authMessage.includes('ูุฌุงุญ')">
          {{ authMessage }}
        </div>
        <button type="submit" class="btn btn-danger w-100 rounded-pill" [disabled]="!authForm.valid || isAuthLoading">
          <span *ngIf="!isAuthLoading">{{ isLoginMode ? 'ุชุณุฌูู ุงูุฏุฎูู' : 'ุฅูุดุงุก ุงูุญุณุงุจ' }}</span>
          <span *ngIf="isAuthLoading" class="spinner-border spinner-border-sm"></span>
        </button>
      </form>
      <div class="auth-footer text-center mt-3">
        <button class="btn btn-link" (click)="toggleAuthMode()">
          {{ isLoginMode ? 'ููุณ ูุฏูู ุญุณุงุจุ ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ' : 'ูุฏูู ุญุณุงุจุ ุชุณุฌูู ุงูุฏุฎูู' }}
        </button>
      </div>
    </div>
  </div>
</div>
